<!DOCTYPE html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width"/>
<title>Local SERP Scraper MVP</title>
<style>
 body{font-family:sans-serif;max-width:700px;margin:30px auto;padding:0 10px}
 input,button{padding:8px;font-size:16px;border:1px solid #ccc;border-radius:4px}
 button{cursor:pointer;margin-left:6px}
 #suggestions{list-style:none;margin:0;padding:0;border:1px solid #ccc;border-top:none;max-height:200px;overflow-y:auto}
 #suggestions li{padding:6px;cursor:pointer}
 #suggestions li:hover{background:#f0f0f0}
 table{border-collapse:collapse;width:100%;margin-top:20px}
 th,td{border:1px solid #ccc;padding:6px;font-size:14px}
 th{background:#fafafa;text-align:left}
</style></head>
<body>
  <h2>Pick Location & Keyword</h2>
  <input id="locInput" placeholder="Type location…">
  <ul id="suggestions"></ul><br>
  <input id="kwInput" placeholder="Keyword (e.g. plumber)" style="width:65%">
  <button id="runBtn">Run</button>
  <div id="status" style="margin-top:12px;font-weight:600;"></div>
  <div id="output"></div>

<script>
const locInput = document.getElementById('locInput');
const kwInput  = document.getElementById('kwInput');
const sugg     = document.getElementById('suggestions');
const runBtn   = document.getElementById('runBtn');
const statusEl = document.getElementById('status');
const out      = document.getElementById('output');

let locTimer;
locInput.addEventListener('input', () => {
  const q = locInput.value.trim();
  clearTimeout(locTimer);
  if (q.length < 2){ sugg.innerHTML=''; return; }
  locTimer = setTimeout(fetchLocs, 300, q);
});

async function fetchLocs(q){
  const r = await fetch(`/api/proxy-locations?q=${encodeURIComponent(q)}`);
  if(!r.ok){sugg.innerHTML='<li>Error</li>';return;}
  const data = await r.json();
  sugg.innerHTML='';
  data.slice(0,10).forEach(loc=>{
    const li=document.createElement('li');
    li.textContent=loc.canonical_name||loc.name;
    li.onclick=()=>{locInput.value=li.textContent;sugg.innerHTML='';};
    sugg.appendChild(li);
  });
}

runBtn.onclick = async ()=>{
  const location = locInput.value.trim();
  const keyword  = kwInput.value.trim();
  if(!location||!keyword){alert('Need location & keyword');return;}
  statusEl.textContent='Running…';
  out.innerHTML='';
  const res = await fetch('/api/run-search',{method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ q: keyword, location })});
  if(!res.ok){statusEl.textContent=`Error ${res.status}`;return;}
  const {results}=await res.json();
  statusEl.textContent=`Got ${results.length} results`;
  render(results);
};

function render(rows){
  const html = `
  <table><thead><tr>
    <th>Domain</th><th>Title</th><th>Meta</th><th>H1</th>
    <th>Words</th><th>Resp (ms)</th></tr></thead><tbody>
    ${rows.map(r=>{
       const dom = (()=>{
         try{return new URL(r.finalUrl).hostname.replace(/^www\./,'');}catch{return'';}
       })();
       return `<tr>
         <td>${dom}</td>
         <td>${safe(r.title)}</td>
         <td>${safe(r.metaDescription)}</td>
         <td>${safe(r.h1)}</td>
         <td>${r.wordCount||''}</td>
         <td>${r.responseTimeMs||''}</td>
       </tr>`;
     }).join('')}
  </tbody></table>`;
  out.innerHTML=html;
}

const safe = t => (t||'').replace(/[<>]/g,'');
</script>
</body>
</html>
